DIT-ES ResourceSync protocol
============================

## General description

The DIT (the harvesting component of the Data Interoperability Toolkit - https://github.com/openminted/omtd-publisher-connector-harvester) will continuously update a ‘omtd-resourcesync’ index into ES. This index will contain two different types:

- resource: keeps track of the current state of the resources to be sync
- change: logs changes of the resources to by sync

Every time the DIT updates one of its resources (i.e. download a new file => *change = ‘created’*), it will post two
new documents into ES:

- resource document:
    - If change == ‘created’: create new document with F’s metadata
    - If change == ‘updated’: update F’s metadata
    - If change == ‘deleted’: delete F’s document in ES
- change document: create a new document logging the occurred change

In this way, the *resource* type will always contain a snapshot of the current state of the resources, in order to easily
generate a resource list from it. Likewise, change lists can be created and updated querying Elasticsearch, providing
a time interval to retrieve the changes we are interested in. In this way, the ResourceSync source will not have any
interaction with the file system and will just refer to the Elasticsearch index as reference for the resources' state.

# Elasticsearch mappings
## *resource* type

Here's the mapping for the resource type of the ‘omtd-resourcesync’ index:

```json
{
  "resource": {
    "_timestamp": {
      "enabled": "true",
      "format": "basic_date_time_no_millis",
      "store": "yes"
    },
    "properties": {
      "location": {
        "type": "nested",
        "properties": {
          "value":{
            "type":"string",
            "index":"not_analyzed"
          },
          "type":{
            "type":"string",
            "index":"not_analyzed"
          }
        }
      },
      "length": {
        "type": "integer",
        "index": "not_analyzed"
      },
      "md5": {
        "type": "string",
        "index": "not_analyzed"
      },
      "mime": {
        "type": "string",
        "index": "not_analyzed"
      },
      "lastmod": {
        "type": "date"
      },
      "res_set": {
        "type": "string",
        "index": "not_analyzed"
      },
      "res_type": {
        "type": "string",
        "index": "not_analyzed"
      },
      "ln": {
        "type": "nested",
        "index_name": "link",
        "properties": {
          "rel": {
            "type": "string",
            "index": "not_analyzed"
          },
          "href": {
            "type": "nested",
            "properties": {
              "value":{
                "type":"string",
                "index":"not_analyzed"
              },
              "type":{
                "type":"string",
                "index":"not_analyzed"
              }
            }
          },
          "mime": {
            "type": "string",
            "index": "not_analyzed"
          }
        }
      }
    }
  }
}
```

For each resource, the following fields will be filled out:

- timestamp: timestamp automatically generated by elasticsearch when the document is created/updated
- location: might be a
    - url
    - absolute file system path
    - relative file system path
- length: length of the resource
- md5: md5 hash of the resource (may become an array of hashes to support different hashing techniques
- mime: mime type of the resource
- lastmod: last modification time of the resource
- capability list: the name of the capability list the resource will belong to
- res_type: type of the resource. It may be useful to create different capability lists for different types of resources
(i.e. /elsevier/metadata -- /elsevier/pdf)
- ln: links to other resources, each one of them can have three fields
    - rel: relationships description (i.e. "describes", "described by")
    - href: link to the resource, similar to "location" (uri/abs_path/rel_path)
    - mime: mime type of the linked resource

## *change* type

Here's the mapping for the change type:
```json
{
  "change": {
    "_timestamp": {
        "enabled": "true",
        "format": "basic_date_time_no_millis",
        "store": "yes"
    },
    "properties": {
      "location": {
        "type": "nested",
        "properties": {
          "value":{
            "type":"string",
            "index":"not_analyzed"
          },
          "type":{
            "type":"string",
            "index":"not_analyzed"
          }
        }
      },
      "change": {
        "type": "string",
        "index": "not_analyzed"
      },
      "lastmod": {
        "type": "date"
      },
      "res_set": {
        "type": "string",
        "index": "not_analyzed"
      },
      "res_type": {
        "type": "string",
        "index": "not_analyzed"
      }
    }
  }
}
```

- timestamp: timestamp automatically generated by elasticsearch when the document is created/updated
- location: might be a
    - url
    - absolute file system path
    - relative file system path
- change: type of the occurred change, can be
    - created
    - updated
    - deleted
- lastmod: last modification time of the resource
- capability list: the name of the capability list the resource will belong to
- res_type: type of the resource. It may be useful to create different capability lists for different types of resources (i.e. /elsevier/metadata -- /elsevier/pdf)
- ln: links to other resources, each one of them can have three fields
    - rel: relationships description (i.e. "describes", "described by")
    - href: link to the resource, similar to "location" (uri/abs_path/rel_path)
    - mime: mime type of the linked resource
